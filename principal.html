<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Principal Dashboard – College Attendance Overview</title>
<script src="common.js"></script>

<style>
  :root {
    --primary: #2563eb;
    --dark-primary: #1e40af;
    --bg: #f3f7ff;
    --text: #1e3a8a;
  }

  body {
    font-family: 'Segoe UI', sans-serif;
    background: var(--bg);
    margin: 0;
    padding: 0;
  }

  header {
    background: linear-gradient(135deg, var(--primary), var(--dark-primary));
    color: white;
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 1000;
  }

  header h2 { margin: 0; font-size: 1.2rem; }
  header button {
    background: white; color: var(--primary);
    border: none; border-radius: 6px; padding: 6px 12px;
    font-weight: 600; cursor:pointer; transition: 0.3s;
  }
  header button:hover { background: #e0ebff; transform: scale(1.05); }

  main { padding: 20px; }

  button, input, select { padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; font-size:14px; }
  .btn { background: linear-gradient(135deg, var(--primary), var(--dark-primary)); color: white; border: none; cursor:pointer; transition:0.2s ease; }
  .btn:hover { transform: scale(1.05); }

  .top-summary { display:flex; flex-wrap:wrap; justify-content:center; gap:15px; margin:20px 0; }
  .top-box { background:white; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); padding:15px 25px; text-align:center; min-width:130px; transition:0.3s; }
  .top-box:hover { transform: scale(1.05); }

  .filters { background:white; border-radius:12px; padding:15px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:15px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:center; }

  #summaryGrid, #classGrid { display:flex; flex-wrap:wrap; gap:15px; justify-content:center; margin-top:15px; }
  #classGrid h3 { width:100%; text-align:center; color:var(--text); }

  .card { background:white; padding:15px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.08); width:200px; text-align:center; cursor:pointer; transition:0.25s ease; }
  .card:hover { transform: scale(1.05); box-shadow:0 4px 12px rgba(0,0,0,0.15); }

  table { width:100%; border-collapse:collapse; margin-top:10px; font-size:14px; }
  th, td { border:1px solid #ddd; padding:8px; text-align:center; }
  th { background: var(--dark-primary); color:white; }

  .lock-toggle { text-align:center; margin:20px 0; }
  .switch { position: relative; display:inline-block; width:70px; height:30px; vertical-align: middle; }
  .switch input { opacity:0; width:0; height:0; }
  .slider { position:absolute; cursor:pointer; inset:0; background-color:#ccc; transition:0.4s; border-radius:30px; }
  .slider:before { position:absolute; content:""; height:24px; width:24px; left:3px; bottom:3px; background:white; transition:transform 0.4s ease; border-radius:50%; }
  input:checked + .slider:before { transform: translateX(40px); }
  input:checked + .slider { background: linear-gradient(135deg, var(--primary), var(--dark-primary)); }
  .slider::after { content: attr(data-label); position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:12px; font-weight:600; color:white; }

  #popupOverlay { position:fixed; inset:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:9999; }
  #popupBox { background:white; border-radius:12px; padding:20px; width:90%; max-height:85%; overflow-y:auto; box-shadow:0 2px 12px rgba(0,0,0,0.3); }
  #popupBox h3 { text-align:center; color:var(--text); }
  #popupBox button.close-popup { background:red; color:white; border:none; border-radius:6px; padding:6px 10px; float:right; cursor:pointer; }

  @media (max-width:768px) {
    .filters { flex-direction:column; text-align:center; }
    .top-summary { flex-direction:column; align-items:center; }
    .card { width:90%; }
    table { font-size:12px; }
  }

  /* small helper */
  .muted { color:#666; font-size:13px; }
</style>
</head>

<body>
  <header>
    <h2>Principal Dashboard – Attendance Overview</h2>
    <button onclick="logout()">Logout</button>
  </header>

  <main>
    <div class="top-summary" id="collegeTopSummary"></div>

    <section class="section">
      <h3 style="text-align:center; color:var(--text); margin-top:0;">College-Wide Attendance Summary</h3>

      <div class="filters">
        <label>Date: <input type="date" id="date"></label>
        <label>Batch:
          <select id="batch">
            <option value="FN">FN</option>
            <option value="AN">AN</option>
          </select>
        </label>
        <button class="btn" id="loadSummaryBtn">Load Summary</button>
        <button class="btn" id="downloadSummaryBtn">Download Summary</button>
        <button class="btn" id="downloadAbsentBtn">Download Absent CSV</button>
        <button class="btn" id="downloadODBtn">Download OD CSV</button>
        <button class="btn" id="viewStatusBtn">View Status</button>
      </div>

      <div class="lock-toggle">
        <label class="switch">
          <input type="checkbox" id="lockToggleBtn" aria-label="Lock Toggle">
          <span class="slider" data-label="Unlock"></span>
        </label>
        <span id="lockMessage" style="color:red; font-weight:600; margin-left:10px;"></span>
      </div>

      <div id="summaryGrid"></div>
      <div id="classGrid"></div>
      <div id="statusTableArea"></div>
    </section>

    <section class="section">
      <h3 style="text-align:center; color:var(--text);">Manage HoD Users</h3>
      <div style="text-align:center; margin-bottom:10px;">
        <button class="btn" id="downloadTemplateBtn">Download Template</button>
        <input type="file" id="hodFile" class="file-input" accept=".csv">
        <button class="btn" id="uploadHoDBtn">Upload HoDs</button>
      </div>
      <table id="hodTable">
        <thead><tr><th>Email</th><th>Name</th><th>Role</th><th>Department</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

<script>
/* ------------------------------
   CONFIG / SAFE FALLBACKS
   ------------------------------ */
const SCRIPT_URL = window.SCRIPT_URL || (typeof window !== 'undefined' && window.location.origin + '/api') || 'https://your-script-url.example.com';

// If common.js provides requireRole, use it; otherwise fallback to a safe stub for local testing.
function safeRequireRole(roleName) {
  if (typeof requireRole === 'function') {
    try { return requireRole(roleName); } catch(e) { console.warn('requireRole threw', e); }
  }
  // fallback: return a default principal for local testing (does not override real common.js behavior)
  return { email: 'principal@domain.com', role: 'Principal' };
}

/* ------------------------------
   STATE
   ------------------------------ */
let collegeData = [];
let collegeClassData = [];
let currentDept = "";
let allAbsentees = [];
let allOD = [];
let currentUser = { email: "", role: "" };

/* ------------------------------
   INIT - attach listeners AFTER DOM ready
   ------------------------------ */
function initPrincipal() {
  // initialize user from common.js requireRole or fallback
  const user = safeRequireRole("Principal") || safeRequireRole("Office") || { email: '', role: '' };
  if (!user || !user.email) {
    // If you need to require login you can handle that in common.js; don't block the page in fallback.
    // For now assign fallback to avoid crashes.
    currentUser = { email: 'principal@domain.com', role: 'Principal' };
  } else {
    currentUser = user;
  }

  // Attach event listeners (single place)
  document.getElementById('loadSummaryBtn').addEventListener('click', loadCollegeSummary);
  document.getElementById('downloadSummaryBtn').addEventListener('click', downloadCollegeSummary);
  document.getElementById('downloadAbsentBtn').addEventListener('click', downloadAbsentReport);
  document.getElementById('downloadODBtn').addEventListener('click', downloadODReport);
  document.getElementById('viewStatusBtn').addEventListener('click', loadAttendanceStatus);

  document.getElementById('downloadTemplateBtn').addEventListener('click', downloadHoDTemplate);
  document.getElementById('uploadHoDBtn').addEventListener('click', uploadHoDUsers);

  const lockCheckbox = document.getElementById('lockToggleBtn');
  lockCheckbox.addEventListener('change', toggleLock);

  // update lock status when date/batch changes
  document.getElementById('date').addEventListener('change', updateLockToggleButton);
  document.getElementById('batch').addEventListener('change', updateLockToggleButton);

  // initial load of HoD users (if any)
  loadHoDUsers();

  // ensure slider label matches initial state
  updateSliderLabel(lockCheckbox);
}

/* ------------------------------
   HELPERS
   ------------------------------ */
function updateSliderLabel(input) {
  const slider = input.nextElementSibling;
  slider && slider.setAttribute('data-label', input.checked ? 'Lock' : 'Unlock');
}

async function safeFetchJSON(url, payload = {}) {
  try {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const text = await res.text();
    // try to parse JSON safely
    try { return JSON.parse(text); } catch(e) { return { success: false, message: 'Invalid JSON response', raw: text }; }
  } catch (err) {
    console.error('Network error:', err);
    return { success: false, message: 'Network error' };
  }
}

/* ------------------------------
   LOAD COLLEGE SUMMARY
   ------------------------------ */
async function loadCollegeSummary() {
  const date = document.getElementById("date").value;
  const batch = document.getElementById("batch").value;
  if (!date) return alert("Select a date");

  const data = await safeFetchJSON(SCRIPT_URL, { action: "getCollegeAttendanceSummary", date, batch });
  if (!data || !data.success) return alert(data.message || 'Failed to load summary');

  collegeData = data.summary || [];
  collegeClassData = data.classRecords || [];
  allAbsentees = data.absent || [];
  allOD = data.od || [];

  renderTopSummary();
  renderDepartmentSummary();
}

/* ------------------------------
   RENDER TOP SUMMARY
   ------------------------------ */
function renderTopSummary() {
  const total = collegeData.reduce((sum, d) => sum + (Number(d.total) || 0), 0);
  const present = collegeData.reduce((sum, d) => sum + (Number(d.present) || 0), 0);
  const absent = collegeData.reduce((sum, d) => sum + (Number(d.absent) || 0), 0);
  const od = collegeData.reduce((sum, d) => sum + (Number(d.od) || 0), 0);
  const percent = total ? ((present / total) * 100).toFixed(2) : "0.00";

  const div = document.getElementById("collegeTopSummary");
  div.innerHTML = `
    <div class="top-box"><strong>Total Students</strong><br>${total}</div>
    <div class="top-box" style="color:green;"><strong>Present</strong><br>${present}</div>
    <div class="top-box" style="color:red;"><strong>Absent</strong><br>${absent}</div>
    <div class="top-box" style="color:orange;"><strong>OD</strong><br>${od}</div>
    <div class="top-box" style="color:violet;"><strong>Attendance %</strong><br>${percent}</div>
  `;
}

/* ------------------------------
   RENDER DEPARTMENTS
   ------------------------------ */
function renderDepartmentSummary() {
  const grid = document.getElementById("summaryGrid");
  const classGrid = document.getElementById("classGrid");
  classGrid.innerHTML = "";
  grid.innerHTML = "";

  (collegeData || []).forEach(d => {
    const t = Number(d.total) || 0;
    const p = Number(d.present) || 0;
    const ab = Number(d.absent) || 0;
    const od = Number(d.od) || 0;
    const percent = t ? ((p / t) * 100).toFixed(2) : "0.00";

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<h4>${d.department}</h4>
                      <p><strong>Total:</strong> ${t}</p>
                      <p style="color:green;"><strong>Present:</strong> ${p}</p>
                      <p style="color:red;"><strong>Absent:</strong> ${ab}</p>
                      <p style="color:orange;"><strong>OD:</strong> ${od}</p>
                      <p><strong>Attendance %:</strong> ${percent}%</p>`;
    card.onclick = () => loadDeptClasses(d.department);
    grid.appendChild(card);
  });
}

/* ------------------------------
   LOAD DEPT CLASSES
   ------------------------------ */
async function loadDeptClasses(dept) {
  currentDept = dept;
  const date = document.getElementById("date").value;
  const batch = document.getElementById("batch").value;
  if (!date) return alert("Select a date");

  const data = await safeFetchJSON(SCRIPT_URL, { action: "getDeptClassSummary", department: dept, date, batch });
  if (!data || !data.success) return alert(data.message || 'Failed to load classes');

  const grid = document.getElementById("classGrid");
  grid.innerHTML = `<h3>${dept} – Class-wise Summary</h3>`;
  (data.records || []).forEach(c => {
    const total = Number(c.total) || 0;
    const present = Number(c.present) || 0;
    const absent = Number(c.absent) || 0;
    const od = Number(c.od) || 0;
    const percent = total ? ((present / total) * 100).toFixed(2) : "0.00";

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<h4>${c.year} ${c.section}</h4>
                      <p><strong>Total: </strong>${total}</p>
                      <p style="color:green;"><strong>Present: </strong>${present}</p>
                      <p style="color:red;"><strong>Absent: </strong>${absent}</p>
                      <p style="color:orange;"><strong>OD: </strong>${od}</p>
                      <p><strong>Attendance %: </strong>${percent}%</p>`;
    grid.appendChild(card);
  });
}

/* ------------------------------
   CSV Downloads
   ------------------------------ */
function downloadAbsentReport(){
  if (!allAbsentees || !allAbsentees.length) return alert("No absent data found");
  const header = ["RollNo","Name","Department","Year","Section","Reason"];
  let csv = header.join(",") + "\n";
  allAbsentees.forEach(r => {
    csv += [r.RollNo, r.Name, r.Department, r.Year, r.Section, (r.Reason||'')].map(v => `"${String(v||'').replace(/"/g,'""')}"`).join(",") + "\n";
  });
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "College_Absent_Report.csv";
  a.click();
}

function downloadODReport(){
  if (!allOD || !allOD.length) return alert("No OD data found");
  const header = ["RollNo","Name","Department","Year","Section","Reason"];
  let csv = header.join(",") + "\n";
  allOD.forEach(r => {
    csv += [r.RollNo, r.Name, r.Department, r.Year, r.Section, (r.Reason||'')].map(v => `"${String(v||'').replace(/"/g,'""')}"`).join(",") + "\n";
  });
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "College_OD_Report.csv";
  a.click();
}

/* ------------------------------
   HOD Users - LOAD / UPLOAD / DOWNLOAD TEMPLATE / DELETE
   ------------------------------ */
async function loadHoDUsers(){
  const data = await safeFetchJSON(SCRIPT_URL, { action: "getUsersByRole", role: "HoD" });
  if (!data || !data.success) return console.warn('Could not load HoD users:', (data && data.message) || data);
  const tbody = document.querySelector("#hodTable tbody");
  tbody.innerHTML = "";
  (data.users || []).forEach(u => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${u.Email}</td><td>${u.Name}</td><td>${u.Role}</td><td>${u.Department}</td>
                    <td><button class="btn" onclick="deleteUser('${u.Email.replace(/'/g,"\\'")}')">Delete</button></td>`;
    tbody.appendChild(tr);
  });
}

function downloadHoDTemplate(){
  const csv = "Email,Password,Name,Role,Department\nhod@domain.com,123456,John Doe,HoD,CSE";
  const blob = new Blob([csv], {type: "text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "HoD_Template.csv";
  a.click();
}

async function uploadHoDUsers(){
  const file = document.getElementById("hodFile").files[0];
  if (!file) return alert("Select CSV file");
  try {
    const text = await file.text();
    const lines = text.split("\n").filter(l => l.trim());
    if (lines.length <= 1) return alert("CSV contains no user rows");
    const users = lines.slice(1).map(l => {
      const [Email, Password, Name, Role, Department] = l.split(",").map(x => (x||'').trim());
      return { Email, Password, Name, Role, Department };
    });
    const data = await safeFetchJSON(SCRIPT_URL, { action: "uploadUsers", users });
    alert(data.message || 'Upload completed.');
    loadHoDUsers();
  } catch (err) {
    console.error(err);
    alert("Error reading file");
  }
}

async function deleteUser(email){
  if (!confirm("Delete this user?")) return;
  const data = await safeFetchJSON(SCRIPT_URL, { action: "deleteUser", email });
  alert(data.message || 'User delete completed');
  loadHoDUsers();
}

/* ------------------------------
   ATTENDANCE STATUS POPUP
   ------------------------------ */
async function loadAttendanceStatus() {
  const date = document.getElementById("date").value;
  const batch = document.getElementById("batch").value;
  if (!date) return alert("Select a date");

  const data = await safeFetchJSON(SCRIPT_URL, { action: "getAttendanceStatusSummary", date, batch });
  if (!data || !data.success) return alert(data.message || 'No data found');

  // remove any existing popup
  const existing = document.getElementById('popupOverlay');
  if (existing) existing.remove();

  // build popup markup
  const overlay = document.createElement('div');
  overlay.id = 'popupOverlay';
  overlay.innerHTML = `
    <div id="popupBox">
      <button class="close-popup" title="Close">Close</button>
      <h3>Attendance Status for ${date} (${batch})</h3>
      <div id="popupInner" style="margin-top:18px;"></div>
    </div>`;

  document.body.appendChild(overlay);

  // close button
  overlay.querySelector('.close-popup').addEventListener('click', () => overlay.remove());

  const inner = document.getElementById('popupInner');

  if (!data.summary || !data.summary.length) {
    inner.innerHTML = '<p class="muted">No records found for selected date & batch.</p>';
    return;
  }

  data.summary.forEach(deptData => {
    const deptSection = document.createElement('div');
    deptSection.style.marginTop = '14px';
    const title = document.createElement('h4');
    title.style.margin = '8px 0';
    title.style.color = 'var(--text)';
    title.textContent = deptData.department;
    deptSection.appendChild(title);

    const rowWrap = document.createElement('div');
    rowWrap.style.display = 'flex';
    rowWrap.style.flexWrap = 'wrap';
    rowWrap.style.gap = '10px';

    (deptData.records || []).sort((a,b) => (a.Year + a.Section).localeCompare(b.Year + b.Section))
      .forEach(r => {
        const status = (r.Status || '');
        let color = 'gray';
        if (status === 'Taken') color = 'green';
        else if (status === 'Not Taken') color = 'red';

        const box = document.createElement('div');
        box.style.background = '#f9f9ff';
        box.style.borderLeft = `6px solid ${color}`;
        box.style.padding = '10px 15px';
        box.style.borderRadius = '8px';
        box.style.minWidth = '120px';
        box.style.textAlign = 'center';
        box.style.fontWeight = '600';
        box.innerHTML = `${r.Year}-${r.Section}<br><span style="color:${color};">${status}</span>`;
        rowWrap.appendChild(box);
      });

    deptSection.appendChild(rowWrap);
    inner.appendChild(deptSection);
  });
}

/* ------------------------------
   DOWNLOAD COLLEGE SUMMARY (classwise)
   ------------------------------ */
function downloadCollegeSummary() {
  if (!collegeClassData || !collegeClassData.length) return alert("No class-wise data available. Please load summary first.");

  const header = ["Department","Year","Section","Total Students","Present","Absent/OD","Attendance %"];
  let csv = header.join(",") + "\n";

  collegeClassData.forEach(c => {
    const total = Number(c.total) || 0;
    const present = Number(c.present) || 0;
    const absent = Number(c.absent) || 0;
    const od = Number(c.od) || 0;
    const absentOrOd = absent + od;
    const percent = total ? ((present / total) * 100).toFixed(2) : "0.00";

    csv += [
      c.Department || "",
      c.Year || "",
      c.Section || "",
      total,
      present,
      absentOrOd,
      `${percent}%`
    ].map(v => `"${String(v||'').replace(/"/g,'""')}"`).join(",") + "\n";
  });

  const date = document.getElementById("date").value || "UnknownDate";
  const batch = document.getElementById("batch").value || "FN";
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `College_Classwise_Summary_${date}_${batch}.csv`;
  a.click();
}

/* ------------------------------
   LOCK / UNLOCK logic (improved)
   ------------------------------ */
async function updateLockToggleButton() {
  const date = document.getElementById("date").value;
  const batch = document.getElementById("batch").value;
  const checkbox = document.getElementById("lockToggleBtn");
  const msg = document.getElementById("lockMessage");

  if (!date || !batch) {
    checkbox.checked = false;
    checkbox.disabled = true;
    msg.innerText = "";
    return;
  }

  checkbox.disabled = false;
  try {
    const data = await safeFetchJSON(SCRIPT_URL, { action: "checkLockStatus", date, batch });
    if (data && data.locked) {
      checkbox.checked = true;
      msg.innerText = `Locked by ${data.role || 'User'} (${data.lockedBy || 'unknown'})`;
      msg.style.color = "green";
    } else {
      checkbox.checked = false;
      msg.innerText = "Unlocked";
      msg.style.color = "red";
    }
    updateSliderLabel(checkbox);
  } catch (err) {
    console.error(err);
    msg.innerText = "Error checking lock status";
    msg.style.color = "red";
  }
}

async function toggleLock() {
  const checkbox = document.getElementById("lockToggleBtn");
  checkbox.disabled = true;

  const date = document.getElementById("date").value;
  const batch = document.getElementById("batch").value;

  if (!date || !batch) {
    alert("Select date & batch first");
    checkbox.disabled = false;
    updateSliderLabel(checkbox);
    return;
  }

  const action = checkbox.checked ? "lockAttendance" : "unlockAttendance";
  const payload = {
    action,
    date,
    batch,
    email: currentUser.email,
    role: currentUser.role
  };

  try {
    const data = await safeFetchJSON(SCRIPT_URL, payload);
    alert(data.message || (action === 'lockAttendance' ? 'Locked' : 'Unlocked'));
  } catch (err) {
    console.error(err);
    alert("Error connecting to server");
  } finally {
    // refresh lock status
    await updateLockToggleButton();
    checkbox.disabled = false;
  }
}

/* ------------------------------
   LOGOUT (simple stub)
   ------------------------------ */
function logout() {
  // If you have logout logic in common.js, it will be used; otherwise just redirect
  try {
    if (typeof signOut === 'function') { signOut(); return; }
  } catch(e){}
  window.location.href = '/logout' /* fallback - adjust to your logout route */;
}

/* ------------------------------
   Boot
   ------------------------------ */
document.addEventListener('DOMContentLoaded', initPrincipal);
</script>

</body>
</html>
