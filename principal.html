<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Principal Dashboard – Modern Admin Panel</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/yourfontawesomekit.js" crossorigin="anonymous"></script>

  <style>
    /* ===== RESET / BASE ===== */
    :root{
      --bg:#f4f7ff; --card:#ffffff; --muted:#6b7280; --accent1:#2563eb; --accent2:#1e40af;
      --glass: rgba(255,255,255,0.6);
      --shadow: 0 8px 24px rgba(15,23,42,0.06);
      --radius: 12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Poppins',system-ui,Segoe UI,Roboto,-apple-system, 'Segoe UI', Arial; background: linear-gradient(180deg,var(--bg), #eef3ff);color:#111827}
    a{color:inherit}

    /* ===== LAYOUT ===== */
    .app{
      display:grid;
      grid-template-columns: 260px 1fr;
      min-height:100vh;
      gap:24px;
    }

    /* ===== SIDEBAR ===== */
    .sidebar{
      background: linear-gradient(180deg, rgba(37,99,235,0.06), rgba(30,64,175,0.02));
      padding:22px; border-radius:16px; margin:20px; height:calc(100vh - 40px); position:sticky; top:10px;
      box-shadow: var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
    .brand h1{font-size:16px;margin:0}
    .nav{margin-top:6px}
    .nav a{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;color:var(--muted);text-decoration:none;margin-bottom:6px}
    .nav a.active, .nav a:hover{background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:white; box-shadow:0 6px 18px rgba(37,99,235,0.12)}
    .nav a i{width:20px;text-align:center}

    /* ===== HEADER ===== */
    header.topbar{display:flex;align-items:center;justify-content:space-between;padding:18px 6px;margin:20px;border-radius:16px;background:transparent}
    .search{flex:1;display:flex;align-items:center;gap:8px}
    .search input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #e6e9f2;background:transparent}

    .actions{display:flex;align-items:center;gap:10px}
    .btn{background:linear-gradient(135deg,var(--accent1),var(--accent2));color:white;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
    .icon-btn{background:transparent;border:1px solid rgba(15,23,42,0.06);padding:8px;border-radius:10px;cursor:pointer}

    /* ===== MAIN CONTENT ===== */
    main{padding:20px;margin-right:20px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;margin-bottom:18px}
    .card{
      background:var(--card);padding:18px;border-radius:var(--radius);box-shadow:var(--shadow); min-height:90px;display:flex;flex-direction:column;justify-content:center;gap:6px
    }
    .card h4{margin:0;font-size:14px;color:var(--muted)}
    .card p{margin:0;font-weight:700;font-size:18px}

    /* large table card */
    .section{background:var(--card);padding:18px;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:18px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center}

    /* class grid (cards) */
    .classgrid{display:flex;flex-wrap:wrap;gap:12px;margin-top:12px}
    .classcard{background:linear-gradient(180deg,#ffffff,#fbfdff);border-radius:10px;padding:14px;min-width:170px;box-shadow:0 6px 18px rgba(30,58,138,0.04);cursor:pointer}

    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid #eef2ff;text-align:center}
    thead th{background:linear-gradient(135deg,var(--accent1),var(--accent2));color:white;border-radius:6px}

    /* popup */
    .overlay{position:fixed;inset:0;background:rgba(10,11,13,0.45);display:flex;align-items:center;justify-content:center;z-index:9999}
    .modal{background:var(--card);width:92%;max-width:760px;border-radius:12px;padding:20px;box-shadow:0 10px 30px rgba(15,23,42,0.2)}

    /* responsive */
    @media (max-width:1000px){
      .app{grid-template-columns:1fr 1fr}
      .grid{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width:720px){
      .app{grid-template-columns:1fr}
      .sidebar{display:flex;flex-direction:row;overflow:auto;height:auto;margin:12px;padding:12px}
      header.topbar{margin:12px}
      main{margin:12px}
      .grid{grid-template-columns:1fr}
      .card p{font-size:16px}
      .nav{display:none}
    }

    /* small helpers */
    .muted{color:var(--muted);font-size:13px}
    .center{text-align:center}

  </style>
</head>
<body onload="initPrincipal()">

  <div class="app">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">PI</div>
        <div>
          <h1 style="font-size:15px;margin:0">Principal Panel</h1>
          <div class="muted" style="font-size:12px">College Attendance Overview</div>
        </div>
      </div>

      <nav class="nav">
        <a href="#" class="active"><i class="fa fa-tachometer-alt"></i> Dashboard</a>
        <a href="#" onclick="document.getElementById('hodFile').scrollIntoView()"><i class="fa fa-users"></i> Manage HoDs</a>
        <a href="#" onclick="document.getElementById('classGrid').scrollIntoView()"><i class="fa fa-chalkboard"></i> Class Summary</a>
        <a href="#" onclick="loadAttendanceStatus();"><i class="fa fa-clipboard-list"></i> View Status</a>
      </nav>

      <div style="margin-top:18px">
        <div style="font-size:12px;color:var(--muted);">Quick actions</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="downloadCollegeSummary()">Export CSV</button>
          <button class="icon-btn" onclick="downloadAbsentReport()" title="Absent CSV"><i class="fa fa-user-times"></i></button>
        </div>
      </div>

      <div style="position:absolute;bottom:24px;left:20px;font-size:12px;color:var(--muted)">Signed in as <strong id="currentEmail">--</strong></div>
    </aside>

    <!-- MAIN -->
    <div style="display:flex;flex-direction:column">
      <header class="topbar">
        <div class="search">
          <input id="globalSearch" placeholder="Search student / department..." oninput="/* search hook */" />
        </div>
        <div class="actions">
          <div style="display:flex;align-items:center;gap:8px">
            <label style="font-size:13px" for="date">Date</label>
            <input id="date" type="date" onchange="updateLockToggleButton()" />
            <select id="batch" onchange="updateLockToggleButton()">
              <option value="FN">FN</option>
              <option value="AN">AN</option>
            </select>
          </div>
          <button class="btn" style="display:flex;align-items:center;gap:8px" onclick="loadCollegeSummary()"><i class="fa fa-sync"></i> Load</button>
          <button class="btn" onclick="logout()">Logout</button>
        </div>
      </header>

      <main>

        <!-- TOP SUMMARY WIDGETS -->
        <div class="grid">
          <div class="card center">
            <h4>Total Students</h4>
            <p id="totalStudents">0</p>
            <div class="muted">Across all departments</div>
          </div>

          <div class="card center">
            <h4>Present</h4>
            <p id="presentStudents">0</p>
            <div class="muted">Marked present</div>
          </div>

          <div class="card center">
            <h4>Absent</h4>
            <p id="absentStudents">0</p>
            <div class="muted">Marked absent</div>
          </div>

          <div class="card center">
            <h4>On Duty (OD)</h4>
            <p id="odStudents">0</p>
            <div class="muted">Approved OD</div>
          </div>

          <div class="card center">
            <h4>Attendance %</h4>
            <p id="attendancePercent">0%</p>
            <div class="muted">College average</div>
          </div>

          <div class="card center">
            <h4>Lock Status</h4>
            <div style="display:flex;align-items:center;gap:8px;justify-content:center">
              <label class="switch" style="position:relative;">
                <input type="checkbox" id="lockToggleBtn">
                <span class="slider" data-label="Unlock" style="display:inline-block;width:70px;height:30px;background:#e5e7eb;border-radius:30px;position:relative;vertical-align:middle"></span>
              </label>
              <div id="lockMessage" style="font-weight:600;color:#ef4444"></div>
            </div>
          </div>
        </div>

        <!-- COLLEGE SECTION -->
        <section class="section">
          <h3 style="margin:0 0 12px 0;color:var(--accent2)">College-Wide Attendance Summary</h3>

          <div class="controls" style="margin-bottom:12px">
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
              <button class="btn" onclick="downloadCollegeSummary()">Download Classwise</button>
              <button class="btn" onclick="downloadAbsentReport()">Download Absent CSV</button>
              <button class="btn" onclick="downloadODReport()">Download OD CSV</button>
              <button class="btn" onclick="loadAttendanceStatus()">View Status</button>
            </div>
          </div>

          <div id="summaryGrid" style="display:flex;flex-wrap:wrap;gap:12px"></div>

          <div id="classGrid" style="margin-top:14px"></div>

          <div id="statusTableArea"></div>
        </section>

        <!-- HOD Management -->
        <section class="section">
          <h3 style="color:var(--accent2);margin:0 0 12px 0">Manage HoD Users</h3>
          <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px">
            <button class="btn" onclick="downloadHoDTemplate()"><i class="fa fa-download"></i> Template</button>
            <input type="file" id="hodFile" accept=".csv">
            <button class="btn" onclick="uploadHoDUsers()">Upload HoDs</button>
          </div>

          <div style="overflow:auto">
            <table id="hodTable">
              <thead>
                <tr><th>Email</th><th>Name</th><th>Role</th><th>Department</th><th>Action</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

      </main>
    </div>
  </div>


  <!-- ORIGINAL JAVASCRIPT (logic preserved, UI hooks adapted) -->
  <script>
    // Keep SCRIPT_URL external variable (unchanged logic)
    // Placeholders for functions referenced in user's logic
    function logout(){ alert('Logging out...'); }
    function requireRole(r){ /* stub - replace with your auth */ return {email:'principal@college.edu', role:'Principal'} }

    function updateSliderLabel(input) {
      const slider = input.nextElementSibling || document.querySelector('.slider');
      slider.setAttribute('data-label', input.checked ? 'Lock' : 'Unlock');
    }

    let collegeData = [];
    let collegeClassData = [];
    let currentDept = "";
    let allAbsentees = [];
    let allOD = [];
    let currentUser = { email: "", role: "" };

    function initPrincipal() {
      const user = requireRole("Principal"); // or "Office" too
      if (!user) return;
      currentUser = user; // <-- initialize here
      document.getElementById('currentEmail').innerText = currentUser.email;
      loadHoDUsers();
      updateLockToggleButton();
    }

    async function loadCollegeSummary() {
      const date = document.getElementById("date").value;
      const batch = document.getElementById("batch").value;
      if(!date) return alert("Select a date");

      const res = await fetch(SCRIPT_URL, {
        method:"POST",
        body: JSON.stringify({ action:"getCollegeAttendanceSummary", date, batch })
      });
      const data = await res.json();
      if(!data.success) return alert(data.message);

      collegeData = data.summary || [];
      collegeClassData = data.classRecords || [];
      allAbsentees = data.absent || [];
      allOD = data.od || [];

      renderTopSummary();
      renderDepartmentSummary();
    }

    function renderTopSummary() {
      const total = collegeData.reduce((sum,d)=>sum+d.total,0);
      const present = collegeData.reduce((sum,d)=>sum+d.present,0);
      const absent = collegeData.reduce((sum,d)=>sum+d.absent,0);
      const od = collegeData.reduce((sum,d)=>sum+d.od,0);
      const percent = total?((present/total)*100).toFixed(2):"0.00";

      document.getElementById('totalStudents').innerText = total;
      document.getElementById('presentStudents').innerText = present;
      document.getElementById('absentStudents').innerText = absent;
      document.getElementById('odStudents').innerText = od;
      document.getElementById('attendancePercent').innerText = percent + '%';

      const div = document.getElementById("collegeTopSummary");
      if(div) div.innerHTML = `...`;
    }

    function renderDepartmentSummary() {
      const grid = document.getElementById("summaryGrid");
      const classGrid = document.getElementById("classGrid");
      classGrid.innerHTML = "";
      grid.innerHTML = "";

      collegeData.forEach(d=>{
        const percent = ((d.present/d.total)*100).toFixed(2);
        const card = document.createElement("div");
        card.className = "classcard";
        card.innerHTML = `<div style=\"font-weight:700;\">${d.department}</div>
                          <div style=\"font-size:13px;margin-top:6px;\">Total: ${d.total}</div>
                          <div style=\"font-size:13px;color:green;\">Present: ${d.present}</div>
                          <div style=\"font-size:13px;color:red;\">Absent: ${d.absent}</div>
                          <div style=\"font-size:13px;color:orange;\">OD: ${d.od}</div>
                          <div style=\"font-size:12px;margin-top:6px;\">${percent}%</div>`;
        card.onclick = ()=>loadDeptClasses(d.department);
        grid.appendChild(card);
      });
    }

    async function loadDeptClasses(dept) {
      currentDept = dept;
      const date = document.getElementById("date").value;
      const batch = document.getElementById("batch").value;

      const res = await fetch(SCRIPT_URL, {
        method:"POST",
        body: JSON.stringify({ action:"getDeptClassSummary", department: dept, date, batch })
      });
      const data = await res.json();
      if(!data.success) return alert(data.message);

      const grid = document.getElementById("classGrid");
      grid.innerHTML = `<h3>${dept} – Class-wise Summary</h3>`;
      data.records.forEach(c=>{
        const percent = ((c.present/c.total)*100).toFixed(2);
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `<h4>${c.year} ${c.section}</h4>
                          <p><strong>Total: </strong>${c.total}</p>
                          <p style=\"color:green;\"><strong>Present: </strong>${c.present}</p>
                          <p style=\"color:red;\"><strong>Absent: </strong>${c.absent}</p>
                          <p style=\"color:orange;\"><strong>OD: </strong>${c.od}</p>
                          <p><strong>Attendance %: </strong>${percent}%</p>`;
        grid.appendChild(card);
      });
    }

    function downloadAbsentReport(){
      if(!allAbsentees.length) return alert("No absent data found");
      const header=["RollNo","Name","Department","Year","Section","Reason"];
      let csv=header.join(",")+"\n";
      allAbsentees.forEach(r=>{
        csv += [r.RollNo,r.Name,r.Department,r.Year,r.Section,r.Reason].join(",")+"\n";
      });
      const blob=new Blob([csv],{type:"text/csv"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download="College_Absent_Report.csv";
      a.click();
    }

    function downloadODReport(){
      if(!allOD.length) return alert("No OD data found");
      const header=["RollNo","Name","Department","Year","Section","Reason"];
      let csv=header.join(",")+"\n";
      allOD.forEach(r=>{
        csv += [r.RollNo,r.Name,r.Department,r.Year,r.Section,r.Reason].join(",")+"\n";
      });
      const blob=new Blob([csv],{type:"text/csv"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download="College_OD_Report.csv";
      a.click();
    }

    async function loadHoDUsers(){
      const res = await fetch(SCRIPT_URL, {
        method:"POST",
        body: JSON.stringify({action:"getUsersByRole", role:"HoD"})
      });
      const data = await res.json();
      if(!data.success) return alert(data.message);
      const tbody = document.querySelector("#hodTable tbody");
      tbody.innerHTML = "";
      data.users.forEach(u=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${u.Email}</td><td>${u.Name}</td><td>${u.Role}</td><td>${u.Department}</td>
                        <td><button class=\"btn\" onclick=\"deleteUser('${u.Email}')\">Delete</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function downloadHoDTemplate(){
      const csv = "Email,Password,Name,Role,Department\nhod@domain.com,123456,John Doe,HoD,CSE";
      const blob = new Blob([csv], {type:"text/csv"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "HoD_Template.csv";
      a.click();
    }

    async function uploadHoDUsers(){
      const file=document.getElementById("hodFile").files[0];
      if(!file) return alert("Select CSV file");
      const text=await file.text();
      const lines=text.split("\n").filter(l=>l.trim());
      const users=lines.slice(1).map(l=>{
        const [Email,Password,Name,Role,Department]=l.split(",");
        return {Email,Password,Name,Role,Department};
      });
      const res=await fetch(SCRIPT_URL,{
        method:"POST",
        body: JSON.stringify({action:"uploadUsers", users})
      });
      const data=await res.json();
      alert(data.message);
      loadHoDUsers();
    }

    async function deleteUser(email){
      if(!confirm("Delete this user?")) return;
      const res=await fetch(SCRIPT_URL,{
        method:"POST",
        body: JSON.stringify({action:"deleteUser", email})
      });
      const data=await res.json();
      alert(data.message);
      loadHoDUsers();
    }

    async function loadAttendanceStatus() {
      const date = document.getElementById("date").value;
      const batch = document.getElementById("batch").value;
      if (!date) return alert("Select a date");

      const res = await fetch(SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify({ action: "getAttendanceStatusSummary", date, batch })
      });
      const data = await res.json();
      if (!data.success) return alert(data.message);

      let html = `<div class=\"overlay\">\n      <div class=\"modal\">\n        <div style=\"display:flex;justify-content:space-between;align-items:center\">\n          <h3 style=\"margin:0;color:var(--accent2)\">Attendance Status for ${date} (${batch})</h3>\n          <button onclick=\"document.querySelector('.overlay').remove()\" style=\"background:#ef4444;color:white;border:none;padding:8px 10px;border-radius:8px\">Close</button>\n        </div>\n        <div style=\"margin-top:12px\">`;

      if (!data.summary.length) {
        html += `<p>No records found for selected date & batch.</p>`;
      } else {
        data.summary.forEach(deptData => {
          html += `<h4 style=\"margin-top:20px;color:var(--accent2)\">${deptData.department}</h4>`;
          html += `<div style=\"display:flex; flex-wrap:wrap; gap:10px;\">`;

          deptData.records
            .sort((a,b)=> (a.Year+b.Section).localeCompare(b.Year+b.Section))
            .forEach(r => {
              let color = "gray";
              let statusText = r.Status;
              if (r.Status === "Taken") color = "green";
              else if (r.Status === "Not Taken") color = "red";
              html += `<div style=\"background:#f9f9ff;border-left:6px solid ${color};padding:10px 15px;border-radius:8px;min-width:120px;text-align:center;font-weight:600\">${r.Year}-${r.Section}<br><span style=\"color:${color}\">${statusText}</span></div>`;
            });

          html += `</div>`;
        });
      }

      html += `</div></div></div>`;
      document.body.insertAdjacentHTML("beforeend", html);
    }

    function downloadCollegeSummary() {
      if (!collegeClassData || !collegeClassData.length)
        return alert("No class-wise data available. Please load summary first.");

      const header = [
        "Department",
        "Year",
        "Section",
        "Total Students",
        "Present",
        "Absent/OD",
        "Attendance %"
      ];
      let csv = header.join(",") + "\n";

      collegeClassData.forEach(c => {
        const total = Number(c.total) || 0;
        const present = Number(c.present) || 0;
        const absent = Number(c.absent) || 0;
        const od = Number(c.od) || 0;
        const absentOrOd = absent + od;
        const percent = total ? ((present / total) * 100).toFixed(2) : "0.00";

        csv += [
          c.Department || "",
          c.Year || "",
          c.Section || "",
          total,
          present,
          absentOrOd,
          `${percent}%`
        ].join(",") + "\n";
      });

      const date = document.getElementById("date").value || "UnknownDate";
      const batch = document.getElementById("batch").value || "FN";
      const blob = new Blob([csv], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `College_Classwise_Summary_${date}_${batch}.csv`;
      a.click();
    }

    async function updateLockToggleButton() {
      const date = document.getElementById("date").value;
      const batch = document.getElementById("batch").value;
      const checkbox = document.getElementById("lockToggleBtn");
      const msg = document.getElementById("lockMessage");

      if (!date || !batch) {
        checkbox.checked = false;
        checkbox.disabled = true;
        msg.innerText = "";
        return;
      }

      checkbox.disabled = false;

      try {
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify({ action: "checkLockStatus", date, batch })
        });
        const data = await res.json();

        if (data.locked) {
          checkbox.checked = true;
          msg.innerText = `Locked by ${data.role} (${data.lockedBy})`;
          msg.style.color = "green";
        } else {
          checkbox.checked = false;
          msg.innerText = "Unlocked";
          msg.style.color = "red";
        }
      } catch (err) {
        console.error(err);
        msg.innerText = "Error checking lock status";
        msg.style.color = "red";
      }
    }

    // add event listeners safely (after DOM exists)
    document.addEventListener('DOMContentLoaded', ()=>{
      const lockEl = document.getElementById("lockToggleBtn");
      if(lockEl) lockEl.addEventListener("change", toggleLock);

      const dateEl = document.getElementById("date");
      if(dateEl) dateEl.addEventListener("change", updateLockToggleButton);
      const batchEl = document.getElementById("batch");
      if(batchEl) batchEl.addEventListener("change", updateLockToggleButton);
    });

    async function toggleLock() {
      const checkbox = document.getElementById("lockToggleBtn");
      checkbox.disabled = true;

      const date = document.getElementById("date").value;
      const batch = document.getElementById("batch").value;

      if (!date || !batch) {
        alert("Select date & batch first");
        checkbox.disabled = false;
        return;
      }

      const action = checkbox.checked ? "lockAttendance" : "unlockAttendance";
      const payload = {
        action,
        date,
        batch,
        email: currentUser.email,
        role: currentUser.role
      };

      try {
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        alert(data.message);
      } catch (err) {
        console.error(err);
        alert("Error connecting to server");
      } finally {
        await updateLockToggleButton();
        checkbox.disabled = false;
        updateSliderLabel(checkbox);
      }
    }

  </script>
</body>
</html>
