<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Faculty Dashboard - Absentees & OD</title>
<script src="common.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  body {
    font-family: 'Poppins', sans-serif;
    background: #eef3ff;
    margin: 0;
    padding: 0;
  }

  header {
    background: linear-gradient(135deg, #1e3a8a, #2563eb);
    color: white;
    text-align: center;
    padding: 15px 10px;
    font-size: 1.4rem;
    font-weight: 600;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  }

  .filters {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    background: white;
    padding: 10px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    margin: 15px auto;
    max-width: 900px;
    gap: 10px;
  }

  input, select {
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 0.95rem;
  }

  .btn {
    background: linear-gradient(135deg, #2563eb, #1e40af);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px 14px;
    cursor: pointer;
    font-weight: 600;
    transition: 0.3s;
  }

  .btn:hover {
    background: #1e40af;
    transform: translateY(-2px);
  }

  #facultySectionInfo {
    text-align: center;
    font-weight: 600;
    color: #1e3a8a;
    margin: 10px;
  }

  /* Table desktop */
  table {
    width: 95%;
    margin: 10px auto;
    border-collapse: collapse;
    background: white;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-radius: 10px;
    overflow: hidden;
  }

  th, td {
    padding: 10px;
    text-align: center;
    border-bottom: 1px solid #ddd;
  }

  th {
    background: #1e3a8a;
    color: white;
    font-weight: 600;
  }

  tr:hover {
    background: #f3f6ff;
  }

  /* Mobile Card View */
  @media(max-width: 768px) {
    table, thead, tbody, th, td, tr {
      display: block;
    }

    thead {
      display: none;
    }

    tbody tr {
      background: white;
      border-radius: 12px;
      margin-bottom: 12px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    td {
      text-align: left;
      padding: 6px 10px;
      display: flex;
      justify-content: space-between;
    }

    td::before {
      content: attr(data-label);
      font-weight: 600;
      color: #1e3a8a;
    }
  }

  .save {
    background: linear-gradient(135deg, #2563eb, #1e40af);
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 10px;
    display: block;
    margin: 20px auto;
    font-weight: 600;
    cursor: pointer;
    transition: 0.3s;
  }

  .save:hover { transform: scale(1.05); }

  .summary-card {
    background: white;
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    width: 180px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }

  .summary-grid {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
  }

  .summary-box h4 { margin: 0; color: #1e3a8a; }

  /* Modal styling */
  .modal {
    display: none;
    position: fixed;
    z-index: 10;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
  }

  .modal-content {
    background: white;
    padding: 20px;
    border-radius: 10px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from {opacity: 0; transform: scale(0.95);}
    to {opacity: 1; transform: scale(1);}
  }

  .close-btn {
    background: red;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 5px 10px;
    float: right;
    cursor: pointer;
  }

  .summary-box {
    text-align: center;
    font-weight: 600;
    margin-top: 10px;
  }
</style>
</head>

<body onload="initFaculty()">
  <header><i class="fa-solid fa-chalkboard-user"></i> Faculty Dashboard â€“ Absentees & OD</header>

  <div id="welcome" style="text-align:center; margin-top:10px; font-weight:600;"></div>

  <div class="filters">
    <label><i class="fa-regular fa-calendar-days"></i> Date:
      <input type="date" id="date">
    </label>
    <label><i class="fa-solid fa-users-rectangle"></i> Batch:
      <select id="batch">
        <option value="FN">FN</option>
        <option value="AN">AN</option>
      </select>
    </label>
    <button class="btn" onclick="loadAbsentees()"><i class="fa-solid fa-rotate"></i> Load</button>
    <button class="btn" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
  </div>

  <div id="facultySectionInfo"></div>

  <table id="dataTable">
    <thead>
      <tr>
        <th>Roll No</th>
        <th>Name</th>
        <th>Year</th>
        <th>Section</th>
        <th>Status</th>
        <th>Reason</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button class="save" onclick="saveUpdates()"><i class="fa-solid fa-floppy-disk"></i> Save Changes</button>

  <h3 style="text-align:center; color:#1e3a8a;">Class Attendance Summary</h3>
  <div id="summary" style="text-align:center; margin-bottom:20px;"></div>

  <!-- History Modal -->
  <div id="historyModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeHistory()">X</button>
      <h3 id="historyTitle" style="text-align:center; color:#1e3a8a;">
        <i class="fa-solid fa-clock-rotate-left"></i> History
      </h3>
      <table style="width:100%; border-collapse:collapse;">
        <thead><tr><th>Date</th><th>Batch</th><th>Status</th><th>Reason</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>
      <div id="historySummary" class="summary-box"></div>
    </div>
  </div>

  <!-- Call Modal -->
  <div id="callModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeCall()">X</button>
      <h3 style="text-align:center; color:#1e3a8a;">
        <i class="fa-solid fa-phone-volume"></i> Parent Contact Info
      </h3>
      <div id="callInfo" style="text-align:center; font-size:16px; margin-top:10px;"></div>
    </div>
  </div>


  <script>
    let absentees = [];
    let user;

    function initFaculty() {
  user = requireRole("faculty"); // lowercase
  if (!user) return;

  // Save email
  localStorage.setItem("facultyEmail", user.email);

  document.getElementById("welcome").innerText =
    `Signed in as: ${user.name} (${user.email})`;
}

    async function loadAbsentees() {
  const date = document.getElementById("date").value;
  const batch = document.getElementById("batch").value;
  const facultyEmail = localStorage.getItem("facultyEmail");

  if (!date || !batch) return alert("Please select both date and batch.");
  if (!facultyEmail) return alert("Faculty email not found. Please log in again.");

  // --- Check lock status ---
  let isLocked = false;
  let lockedBy = "";
  try {
    const lockCheck = await fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify({ action: "checkLockStatus", date, batch })
    });
    const lockData = await lockCheck.json();
    if (lockData.locked) {
      isLocked = true;
      lockedBy = `${lockData.role || 'Unknown Role'} (${lockData.lockedBy || 'Unknown'})`;
      alert(`Attendance is locked for this date & batch.\nLocked by admin.\nYou can only view data.`);
    }
  } catch (err) {
    console.error("Lock check failed:", err);
  }

  // --- Fetch data anyway (for view mode) ---
  const res = await fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "getAbsenteesForFaculty",
      email: facultyEmail,
      date,
      batch
    })
  });

  const data = await res.json();
  if (!data.success) return alert(data.message);

  absentees = data.records || data.data || [];
  window._facultyClassList = data.fullClass || [];

  renderTable(isLocked);
  renderSummary();

  // --- Display section info ---
  document.getElementById("facultySectionInfo").innerText =
    `Loaded: ${data.department || user.department} - ${data.year || user.year} ${data.section || user.section}`;

  // --- Disable or enable save button based on lock ---
  const saveBtn = document.querySelector(".save");
  saveBtn.disabled = isLocked;
  saveBtn.style.opacity = isLocked ? "0.6" : "1.0";
}


    function renderSummary() {
  const summaryDiv = document.getElementById("summary");
  const classList = window._facultyClassList || [];
  if (!classList.length) {
    summaryDiv.innerHTML = "No class data available.";
    return;
  }

  // Build totals
  const classMap = {};
  classList.forEach(s => {
    const key = `${s.Year} ${s.Section}`;
    if (!classMap[key]) classMap[key] = { total: 0, absent: 0 };
    classMap[key].total++;
  });

  absentees.forEach(s => {
    const key = `${s.Year} ${s.Section}`;
    if (classMap[key]) classMap[key].absent++;
  });

  // Build summary grid
  let html = '<div style="display:flex; flex-wrap:wrap; justify-content:center; gap:15px;">';
  for (const key in classMap) {
    const [year, section] = key.split(" ");
    const c = classMap[key];
    const present = c.total - c.absent;
    const percent = ((present / c.total) * 100).toFixed(2);
    html += `
      <div style="background:white; padding:15px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); width:180px; text-align:center;">
        <h4 style="margin:0 0 8px 0; color:#1e3a8a;">${year} ${section}</h4>
        <p><strong>Total:</strong> ${c.total}</p>
        <p style="color:green;"><strong>Present:</strong> ${present}</p>
        <p style="color:red;"><strong>Absent/OD:</strong> ${c.absent}</p>
        <p><strong>Attendance %:</strong> ${percent}%</p>
      </div>`;
  }
  html += "</div>";
  summaryDiv.innerHTML = html;
}



    function renderTable(isLocked = false) {
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "";

  absentees.forEach((s, i) => {
    tbody.innerHTML += `
      <tr>
        <td>${s.RollNo}</td>
        <td>${s.Name}</td>
        <td>${s.Year}</td>
        <td>${s.Section}</td>
        <td>
          ${
            isLocked
              ? `<span>${s.Status}</span>`
              : `<select onchange="absentees[${i}].Status=this.value">
                   <option ${s.Status==='Absent'?'selected':''}>Absent</option>
                   <option ${s.Status==='OD'?'selected':''}>OD</option>
                 </select>`
          }
        </td>
        <td>
          ${
            isLocked
              ? `<span>${s.Reason || '-'}</span>`
              : `<input type="text" value="${s.Reason||''}" onchange="absentees[${i}].Reason=this.value" style="width:120px;">`
          }
        </td>
        <td>
          <button class="btn" onclick="viewHistory('${s.RollNo}','${s.Name}')">History</button>
          <button class="btn" onclick="callParent('${s.ParentPhone||''}', ${i})">Call</button>
          ${
            !isLocked
              ? `<button class="btn" onclick="editParent(${i})">Edit</button>`
              : ''
          }
        </td>
      </tr>`;
  });
}


    function editParent(index) {
      const s = absentees[index];
      //const newName = prompt("Edit Parent Name:", s.ParentName || "");
      const newPhone = prompt("Edit Parent Phone:", s.ParentPhone || "");
      //if (newName !== null) absentees[index].ParentName = newName;
      if (newPhone !== null) absentees[index].ParentPhone = newPhone;
      alert("Parent info updated locally. Click 'Save Changes' to store.");
    }

    async function viewHistory(rollNo, name) {
      const res = await fetch(SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify({ action: "getStudentHistory", rollNo })
      });
      const data = await res.json();
      if (!data.success) return alert(data.message);

      const records = data.records;
      const body = document.getElementById("historyBody");
      const title = document.getElementById("historyTitle");
      const summary = document.getElementById("historySummary");
      body.innerHTML = "";
      title.innerText = `History of ${name} (${rollNo})`;

      let absentCount = 0, odCount = 0;
      records.forEach(r => {
        if (r.Status === "Absent") absentCount++;
        if (r.Status === "OD") odCount++;
        body.innerHTML += `<tr>
          <td>${r.Date}</td><td>${r.Batch}</td>
          <td>${r.Status}</td><td>${r.Reason || ''}</td></tr>`;
      });
      summary.innerHTML = `Total: ${records.length} | Absent: ${absentCount} | OD: ${odCount}`;

      document.getElementById("historyModal").style.display = "flex";
    }

    function closeHistory() {
      document.getElementById("historyModal").style.display = "none";
    }

    function callParent(phoneNumber, index) {
  const s = absentees[index];
  if (!s.ParentPhone && !phoneNumber)
    return alert("Parent phone number not available!");

  const parentName = s.ParentName || "Not provided";
  const parentPhone = s.ParentPhone || phoneNumber || "Not provided";

  const infoDiv = document.getElementById("callInfo");
  infoDiv.innerHTML = `
    <p><strong>Parent Name:</strong> ${parentName}</p>
    <p><strong>Phone Number:</strong> ${parentPhone}</p>
    <button onclick="makeCall('${parentPhone}')" 
      style="background:#2563eb; color:white; border:none; padding:8px 14px;
             border-radius:6px; margin-top:10px; cursor:pointer; font-weight:600;">
      Call Parent
    </button>
  `;

  document.getElementById("callModal").style.display = "flex";
}

function makeCall(number) {
  if (!number || number === "Not provided")
    return alert("Phone number not available!");
  window.open(`tel:${number}`);
}

function closeCall() {
  document.getElementById("callModal").style.display = "none";
}

    async function saveUpdates() {
  const date = document.getElementById("date").value;
  const batch = document.getElementById("batch").value;
  if (!date) return alert("Select a date first!");

  const res = await fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "saveFacultyUpdates",
      date, batch, updates: absentees
    }),
  });
  const result = await res.json();
  alert(result.message);
  if (result.success) await loadAbsentees(); // refresh local data from sheet
}

  </script>
</body>
</html>
