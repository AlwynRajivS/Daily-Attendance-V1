<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Faculty Dashboard - Absentees & OD</title>
<script src="common.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
  body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(180deg, #f5f8ff, #eef3ff);
    margin: 0; padding: 0;
  }
  header {
    background: linear-gradient(135deg, #1e3a8a, #2563eb);
    color: white;
    padding: 15px 10px;
    text-align: center;
    font-size: 1.5em;
    font-weight: 600;
    letter-spacing: 0.5px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.1);
  }

  .top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    flex-wrap: wrap;
  }
  .top-bar button {
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    cursor: pointer;
    font-weight: 600;
  }
/* Add or replace this part in your CSS */
.popup {
  display: none;
  position: fixed;
  z-index: 999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  justify-content: center;
  align-items: center;
}

.popup-content {
  background: white;
  border-radius: 16px;
  padding: 20px;
  width: 90%;
  max-width: 400px;
  max-height: 80vh;          /* Limit popup height */
  overflow-y: auto;           /* Enable scrolling when overflow */
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}

.popup-content h3 {
  margin-top: 0;
  color: #1e3a8a;
}

.popup-content button {
  background: linear-gradient(135deg, #2563eb, #1e40af);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 8px 14px;
  cursor: pointer;
  margin-top: 10px;
  transition: 0.2s;
}

.popup-content button:hover {
  transform: scale(1.05);
}

  .filters {
    text-align: center;
    padding: 15px;
  }
  input, select {
    padding: 8px;
    margin: 5px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 15px;
  }
  .btn {
    background: linear-gradient(135deg, #2563eb, #1e40af);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 15px;
    cursor: pointer;
    font-weight: 600;
    transition: 0.2s;
  }
  .btn:hover { transform: scale(1.05); }

  table {
    width: 95%;
    margin: 15px auto;
    border-collapse: collapse;
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  th, td {
    padding: 10px;
    text-align: center;
    border-bottom: 1px solid #e5e7eb;
  }
  th {
    background: #1e3a8a;
    color: white;
    font-size: 15px;
  }
  tr:hover { background: #f1f5ff; }

  button.save {
    display: block;
    margin: 20px auto;
    background: #2563eb;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: 0.3s;
  }
  button.save:hover { background: #1d4ed8; transform: scale(1.05); }

  #summary {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
  }
  .summary-card {
    background: white;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    width: 180px;
    text-align: center;
  }

  /* Modals */
  /* === History Modal === */
 #historyModal {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 1200;
    background: rgba(0,0,0,0.48);
    justify-content: center;
    align-items: center;
    padding: 12px;
    -webkit-font-smoothing:antialiased;
  }

  #historyModal[aria-hidden="false"] { display: flex; }

  .history-card {
    position: relative;
    width: 100%;
    max-width: 520px;
    max-height: 86vh;            /* responsive height */
    background: #ffffff;
    border-radius: 14px;
    overflow: hidden;
    box-shadow: 0 12px 30px rgba(22, 28, 45, 0.18);
    display: flex;
    flex-direction: column;
    animation: slideUp 260ms cubic-bezier(.2,.9,.2,1);
  }

  @keyframes slideUp {
    from { transform: translateY(18px); opacity: 0; }
    to   { transform: translateY(0); opacity: 1; }
  }

  .history-header {
    display:flex;
    align-items:center;
    gap:10px;
    padding:14px 16px;
    background: linear-gradient(90deg,#1e3a8a,#2563eb);
    color:#fff;
  }
  .history-header .title {
    font-size:16px;
    font-weight:700;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .history-header .subtitle {
    margin-left:auto;
    font-size:13px;
    opacity:0.95;
    font-weight:600;
  }

  .history-close {
    position:absolute;
    right:10px;
    top:10px;
    background:#ff6b6b;
    color:#fff;
    width:34px;height:34px;
    border-radius:50%;
    border:0;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    font-weight:700;
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
  }
  .history-close:active { transform:scale(.98); }

  .history-body {
    padding: 12px 12px 16px;
    overflow-y: auto;
  }
  /* Sticky table header inside scrollable body */
  .history-table {
    width:100%;
    border-collapse:collapse;
    font-size:14px;
    min-width: 420px; /* keep columns readable on larger phones; will stack on tiny screens */
  }

  .history-table thead th {
    position: sticky;
    top: 0;
    background: #eef4ff;
    color: #0f172a;
    font-weight:700;
    padding:8px 10px;
    text-align:left;
    border-bottom: 1px solid rgba(14, 36, 70, 0.06);
    z-index: 2;
  }

  .history-table tbody td {
    padding:10px 10px;
    border-bottom: 1px solid #f1f5ff;
    color: #0f172a;
    vertical-align: top;
    word-break: break-word;
  }

  .history-table tbody tr:nth-child(even) { background: #fbfdff; }

  /* Status color chips */
  .status-chip {
    display:inline-block;
    padding:4px 8px;
    border-radius:999px;
    font-weight:700;
    font-size:12px;
    color:#fff;
  }
  .status-present { background:#16a34a; }   /* green */
  .status-absent  { background:#dc2626; }   /* red */
  .status-od      { background:#7c3aed; }   /* purple */

  /* Summary */
  #historySummary {
    margin-top:12px;
    padding:10px 14px;
    text-align:center;
    font-weight:700;
    color:#0f172a;
    background:#f8fbff;
    border-radius:10px;
  }
  /* Mobile Responsive */
  @media (max-width: 768px) {
    table, thead, tbody, th, td, tr {
      display: block;
    }
    thead tr { display: none; }
    td {
      position: relative;
      padding-left: 50%;
      text-align: left;
    }
    td:before {
      position: absolute;
      left: 10px;
      width: 45%;
      font-weight: 600;
      color: #1e3a8a;
      white-space: nowrap;
    }
    td:nth-of-type(1):before { content: "Roll No"; }
    td:nth-of-type(2):before { content: "Name"; }
    td:nth-of-type(3):before { content: "Year"; }
    td:nth-of-type(4):before { content: "Section"; }
    td:nth-of-type(5):before { content: "Status"; }
    td:nth-of-type(6):before { content: "Reason"; }
    td:nth-of-type(7):before { content: "Action"; }
   
  }
  @media (max-width: 480px) {
    .history-table { min-width: initial; font-size:13px; }
    /* Turn each table row to a stacked card look */
    .history-table thead { display:none; }
    .history-table tbody td {
      display:block;
      padding:10px 12px;
    }
    .history-table tbody td:before {
      content: attr(data-label);
      display:block;
      font-weight:700;
      color:#1e3a8a;
      margin-bottom:6px;
    }
    .history-table tbody tr { margin-bottom:12px; display:block; box-shadow: 0 2px 10px rgba(12,18,46,0.04); border-radius:10px; overflow:hidden; }
  }

  /* Very small tweaks for ultra-small devices */
  @media (max-height: 520px) {
    .history-card { max-height: 92vh; }
    .history-header { padding:12px; }
    .history-close { width:30px;height:30px; right:8px; top:8px; }
  }
</style>
</head>

<body onload="initFaculty()">

<header>üìò Faculty Dashboard ‚Äì Absentees & OD</header>

<div class="top-bar">
  <div id="welcome" style="font-weight:600; color:#1e3a8a;">üë®‚Äçüè´ Loading...</div>
  <button onclick="logout()">Logout</button>
</div>

<div class="filters">
  <label>Date: <input type="date" id="date"></label>
  <label>Batch:
    <select id="batch">
      <option value="FN">FN</option>
      <option value="AN">AN</option>
    </select>
  </label>
  <button class="btn" onclick="loadAbsentees()">Load</button>
</div>

<div id="facultySectionInfo" 
  style="text-align:center; font-weight:600; color:#2563eb; margin-bottom:10px;">
</div>

<table id="dataTable">
  <thead>
    <tr>
      <th>Roll No</th>
      <th>Name</th>
      <th>Year</th>
      <th>Section</th>
      <th>Status</th>
      <th>Reason</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button class="save" onclick="saveUpdates()">üíæ Save Changes</button>

<h3 style="text-align:center; color:#1e3a8a;">üìä Class Attendance Summary</h3>
<div id="summary"></div>

<!-- History Modal -->
<div id="historyModal" class="modal" role="dialog" aria-hidden="true" aria-labelledby="historyTitle">
  <div class="history-card" role="document">
    <div class="history-header">
      <div class="title">üìú <span id="historyTitle" style="display:inline-block; margin-left:6px;">Attendance History</span></div>
      <div class="subtitle" id="historyCount"> </div>
      <button class="history-close" aria-label="Close history" onclick="closeHistory()">‚úï</button>
    </div>

    <div class="history-body">
      <div style="overflow:auto;">
        <table class="history-table" aria-describedby="historySummary">
          <thead>
            <tr>
              <th style="width:22%;">Date</th>
              <th style="width:18%;">Batch</th>
              <th style="width:20%;">Status</th>
              <th style="width:40%;">Reason</th>
            </tr>
          </thead>
          <tbody id="historyBody">
            <!-- Rows injected here -->
          </tbody>
        </table>
      </div>

      <div id="historySummary" aria-live="polite"></div>
    </div>
  </div>
</div>

<!-- Call Modal -->
<div id="callModal" class="modal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeCall()">X</button>
    <h3>üìû Parent Contact Info</h3>
    <div id="callInfo" style="text-align:center; font-size:16px; margin-top:10px;"></div>
  </div>
</div>

<script>
  let absentees = [];
  let user;

  function initFaculty() {
    user = requireRole("faculty");
    if (!user) return;
    localStorage.setItem("facultyEmail", user.email);
    document.getElementById("welcome").innerText =
      `üë®‚Äçüè´ ${user.name} (${user.email})`;
  }

  async function loadAbsentees() {
    const date = document.getElementById("date").value;
    const batch = document.getElementById("batch").value;
    const facultyEmail = localStorage.getItem("facultyEmail");
    if (!date || !batch) return alert("Please select both date and batch.");
    if (!facultyEmail) return alert("Faculty email not found. Please log in again.");

    let isLocked = false;
    try {
      const lockCheck = await fetch(SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify({ action: "checkLockStatus", date, batch })
      });
      const lockData = await lockCheck.json();
      if (lockData.locked) {
        isLocked = true;
        alert(`Attendance is locked for this date & batch.\nYou can only view data.`);
      }
    } catch (err) {
      console.error("Lock check failed:", err);
    }

    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify({
        action: "getAbsenteesForFaculty",
        email: facultyEmail,
        date,
        batch
      })
    });

    const data = await res.json();
    if (!data.success) return alert(data.message);
    absentees = data.records || data.data || [];

    renderTable(isLocked);
    renderSummary();
    document.getElementById("facultySectionInfo").innerText =
      `Loaded: ${data.department || user.department} - ${data.year || user.year} ${data.section || user.section}`;

    const saveBtn = document.querySelector(".save");
    saveBtn.disabled = isLocked;
    saveBtn.style.opacity = isLocked ? "0.6" : "1";
  }

  function renderSummary() {
    const summaryDiv = document.getElementById("summary");
    summaryDiv.innerHTML = "";
    if (!absentees.length) {
      summaryDiv.innerHTML = "<p>No records found.</p>";
      return;
    }
    const classMap = {};
    absentees.forEach(s => {
      const key = `${s.Year} ${s.Section}`;
      if (!classMap[key]) classMap[key] = { total: 0, present: 0, absent: 0 };
      classMap[key].total++;
      if (s.Status === "Absent" || s.Status === "OD") classMap[key].absent++;
      else classMap[key].present++;
    });
    for (const key in classMap) {
      const c = classMap[key];
      const percent = ((c.present / c.total) * 100).toFixed(2);
      summaryDiv.innerHTML += `
        <div class="summary-card">
          <h4 style="color:#1e3a8a; margin:0 0 8px;">${key}</h4>
          <p><b>Total:</b> ${c.total}</p>
          <p style="color:green;"><b>Present:</b> ${c.present}</p>
          <p style="color:red;"><b>Absent/OD:</b> ${c.absent}</p>
          <p><b>Attendance:</b> ${percent}%</p>
        </div>`;
    }
  }

  function renderTable(isLocked = false) {
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";
    absentees.forEach((s, i) => {
      tbody.innerHTML += `
        <tr>
          <td>${s.RollNo}</td>
          <td>${s.Name}</td>
          <td>${s.Year}</td>
          <td>${s.Section}</td>
          <td>${isLocked ? `<span>${s.Status}</span>` :
            `<select onchange="absentees[${i}].Status=this.value">
              <option ${s.Status==='Absent'?'selected':''}>Absent</option>
              <option ${s.Status==='OD'?'selected':''}>OD</option>
            </select>`}
          </td>
          <td>${isLocked ? `<span>${s.Reason||'-'}</span>` :
            `<input type="text" value="${s.Reason||''}" onchange="absentees[${i}].Reason=this.value" style="width:120px;">`}
          </td>
          <td>
            <button class="btn" onclick="viewHistory('${s.RollNo}','${s.Name}')">üìú</button>
            <button class="btn" onclick="callParent('${s.ParentPhone||''}', ${i})">üìû</button>
            ${!isLocked ? `<button class="btn" onclick="editParent(${i})">‚úèÔ∏è</button>` : ''}
          </td>
        </tr>`;
    });
  }

  function editParent(index) {
    const s = absentees[index];
    const newPhone = prompt("Edit Parent Phone:", s.ParentPhone || "");
    if (newPhone !== null) absentees[index].ParentPhone = newPhone;
    alert("Parent info updated locally. Click 'Save Changes' to store.");
  }

  async function viewHistory(rollNo, name) {
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify({ action: "getStudentHistory", rollNo })
    });
    const data = await res.json();
    if (!data.success) return alert(data.message);
    const records = data.records;
    const body = document.getElementById("historyBody");
    body.innerHTML = "";
    document.getElementById("historyTitle").innerText = `üìú History of ${name} (${rollNo})`;
    let absentCount = 0, odCount = 0;
    records.forEach(r => {
      if (r.Status === "Absent") absentCount++;
      if (r.Status === "OD") odCount++;
      body.innerHTML += `<tr><td>${r.Date}</td><td>${r.Batch}</td><td>${r.Status}</td><td>${r.Reason||''}</td></tr>`;
    });
    document.getElementById("historySummary").innerHTML = 
      `Total: ${records.length} | Absent: ${absentCount} | OD: ${odCount}`;
    document.getElementById("historyModal").style.display = "flex";
  }

  function closeHistory() { document.getElementById("historyModal").style.display = "none"; }

  function callParent(phoneNumber, index) {
    const s = absentees[index];
    if (!s.ParentPhone && !phoneNumber) return alert("Parent phone number not available!");
    const parentName = s.ParentName || "Not provided";
    const parentPhone = s.ParentPhone || phoneNumber || "Not provided";
    document.getElementById("callInfo").innerHTML = `
      <p><strong>Parent Name:</strong> ${parentName}</p>
      <p><strong>Phone:</strong> ${parentPhone}</p>
      <button onclick="makeCall('${parentPhone}')" class="btn">üìû Call Parent</button>`;
    document.getElementById("callModal").style.display = "flex";
  }
  function makeCall(num) {
    if (!num || num === "Not provided") return alert("Phone number not available!");
    window.open(`tel:${num}`);
  }
  function closeCall() { document.getElementById("callModal").style.display = "none"; }

  async function saveUpdates() {
    const date = document.getElementById("date").value;
    const batch = document.getElementById("batch").value;
    if (!date) return alert("Select a date first!");
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify({ action: "saveFacultyUpdates", date, batch, updates: absentees })
    });
    const result = await res.json();
    alert(result.message);
    if (result.success) await loadAbsentees();

    function openPopup() {
  document.getElementById("popup").style.display = "flex";
}

function closePopup() {
  document.getElementById("popup").style.display = "none";
}

  }

(function(){
    const modal = document.getElementById('historyModal');

    // openHistory should set aria-hidden to false and fill content, then show modal
    window.openHistoryModal = function() {
      modal.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden'; // prevent body scroll while modal open
      // focus management (optional)
      const close = modal.querySelector('.history-close');
      if (close) close.focus();
    };

    window.closeHistory = function() {
      modal.setAttribute('aria-hidden','true');
      document.body.style.overflow = ''; // restore body scroll
    };

    // Close on backdrop click
    modal.addEventListener('click', (ev) => {
      if (ev.target === modal) closeHistory();
    });

    // Close on ESC
    document.addEventListener('keydown', (ev) => {
      if (ev.key === 'Escape' && modal.getAttribute('aria-hidden') === 'false') {
        closeHistory();
      }
    });

    // Utility: render history rows safely (use your existing data-fetch code to populate)
    // Example usage (from your existing viewHistory function):
    //   populateHistory(recordsArray, name, rollNo)
    window.populateHistory = function(records, nameRoll) {
      const tbody = document.getElementById('historyBody');
      const summary = document.getElementById('historySummary');
      const count = document.getElementById('historyCount');
      tbody.innerHTML = '';
      let absent=0, od=0;
      (records || []).forEach(r => {
        const status = String(r.Status || '').trim();
        if (status === 'Absent') absent++;
        if (status === 'OD') od++;
        const chipClass = status === 'Absent' ? 'status-absent' : (status === 'OD' ? 'status-od' : 'status-present');

        const row = document.createElement('tr');
        // On small screens we rely on data-label for stacked view
        row.innerHTML = `
          <td data-label="Date">${r.Date || '-'}</td>
          <td data-label="Batch">${r.Batch || '-'}</td>
          <td data-label="Status"><span class="status-chip ${chipClass}">${status || 'Present'}</span></td>
          <td data-label="Reason">${r.Reason || '-'}</td>
        `;
        tbody.appendChild(row);
      });

      summary.textContent = `Total: ${records.length || 0}  |  Absent: ${absent}  |  OD: ${od}`;
      count.textContent = `${nameRoll || ''}`;
      openHistoryModal();
    };
  })();

  
</script>
</body>
</html>




