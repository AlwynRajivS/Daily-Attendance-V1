<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Faculty Dashboard - Absentees & OD</title>
<script src="common.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
  body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(180deg, #f5f8ff, #eef3ff);
    margin: 0; padding: 0;
  }
  header {
    background: linear-gradient(135deg, #1e3a8a, #2563eb);
    color: white;
    padding: 15px 10px;
    text-align: center;
    font-size: 1.5em;
    font-weight: 600;
    letter-spacing: 0.5px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.1);
  }

  .top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    flex-wrap: wrap;
  }
  .top-bar button {
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    cursor: pointer;
    font-weight: 600;
  }
/* Add or replace this part in your CSS */
.popup {
  display: none;
  position: fixed;
  z-index: 999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  justify-content: center;
  align-items: center;
}

.popup-content {
  background: white;
  border-radius: 16px;
  padding: 20px;
  width: 90%;
  max-width: 400px;
  max-height: 80vh;          /* Limit popup height */
  overflow-y: auto;           /* Enable scrolling when overflow */
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}

.popup-content h3 {
  margin-top: 0;
  color: #1e3a8a;
}

.popup-content button {
  background: linear-gradient(135deg, #2563eb, #1e40af);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 8px 14px;
  cursor: pointer;
  margin-top: 10px;
  transition: 0.2s;
}

.popup-content button:hover {
  transform: scale(1.05);
}

  .filters {
    text-align: center;
    padding: 15px;
  }
  input, select {
    padding: 8px;
    margin: 5px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 15px;
  }
  .btn {
    background: linear-gradient(135deg, #2563eb, #1e40af);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 15px;
    cursor: pointer;
    font-weight: 600;
    transition: 0.2s;
  }
  .btn:hover { transform: scale(1.05); }

  table {
    width: 95%;
    margin: 15px auto;
    border-collapse: collapse;
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  th, td {
    padding: 10px;
    text-align: center;
    border-bottom: 1px solid #e5e7eb;
  }
  th {
    background: #1e3a8a;
    color: white;
    font-size: 15px;
  }
  tr:hover { background: #f1f5ff; }

  button.save {
    display: block;
    margin: 20px auto;
    background: #2563eb;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: 0.3s;
  }
  button.save:hover { background: #1d4ed8; transform: scale(1.05); }

  #summary {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
  }
  .summary-card {
    background: white;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    width: 180px;
    text-align: center;
  }

  /* Modals */
  /* === History Modal === */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 9999;
  background: rgba(0,0,0,0.45);
  justify-content: center;
  align-items: center;
  padding: 12px;
}

.modal-content {
  position: relative;
  background: #fff;
  border-radius: 16px;
  width: 95%;
  max-width: 480px;
  max-height: 85vh;          /* limit height for mobile */
  overflow-y: auto;           /* scroll when content overflows */
  padding: 20px 16px 16px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.2);
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from { transform: translateY(30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

/* Close button */
.close-btn {
  position: absolute;
  top: 10px;
  right: 14px;
  background: #ef4444;
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 28px;
  height: 28px;
  cursor: pointer;
  font-weight: bold;
  font-size: 14px;
  line-height: 26px;
  transition: 0.2s;
}
.close-btn:hover { background: #dc2626; transform: scale(1.1); }

/* Title */
.modal-content h3 {
  margin: 0 0 12px;
  font-size: 18px;
  color: #1e3a8a;
  text-align: center;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 6px;
}
.modal-content h3::before {
  content: "";
  font-size: 20px;
}

/* Table */
.modal-content table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}
.modal-content th {
  background: #2563eb;
  color: #fff;
  padding: 8px;
  text-align: left;
  border-radius: 4px 4px 0 0;
}
.modal-content td {
  padding: 8px;
  border-bottom: 1px solid #eee;
  word-break: break-word;
}
.modal-content tr:nth-child(even) {
  background: #f8f9ff;
}

/* Summary */
#historySummary {
  text-align: center;
  margin-top: 12px;
  font-weight: 600;
  color: #1e3a8a;
}
  /* Mobile Responsive */
  @media (max-width: 768px) {
    table, thead, tbody, th, td, tr {
      display: block;
    }
    thead tr { display: none; }
    td {
      position: relative;
      padding-left: 50%;
      text-align: left;
    }
    td:before {
      position: absolute;
      left: 10px;
      width: 45%;
      font-weight: 600;
      color: #1e3a8a;
      white-space: nowrap;
    }
    td:nth-of-type(1):before { content: "Roll No"; }
    td:nth-of-type(2):before { content: "Name"; }
    td:nth-of-type(3):before { content: "Year"; }
    td:nth-of-type(4):before { content: "Section"; }
    td:nth-of-type(5):before { content: "Status"; }
    td:nth-of-type(6):before { content: "Reason"; }
    td:nth-of-type(7):before { content: "Action"; }
   
  }
</style>
</head>

<body onload="initFaculty()">

<header>üìò Faculty Dashboard ‚Äì Absentees & OD</header>

<div class="top-bar">
  <div id="welcome" style="font-weight:600; color:#1e3a8a;">üë®‚Äçüè´ Loading...</div>
  <button onclick="logout()">Logout</button>
</div>

<div class="filters">
  <label>Date: <input type="date" id="date"></label>
  <label>Batch:
    <select id="batch">
      <option value="FN">FN</option>
      <option value="AN">AN</option>
    </select>
  </label>
  <button class="btn" onclick="loadAbsentees()">Load</button>
</div>

<div id="facultySectionInfo" 
  style="text-align:center; font-weight:600; color:#2563eb; margin-bottom:10px;">
</div>

<table id="dataTable">
  <thead>
    <tr>
      <th>Roll No</th>
      <th>Name</th>
      <th>Year</th>
      <th>Section</th>
      <th>Status</th>
      <th>Reason</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button class="save" onclick="saveUpdates()">üíæ Save Changes</button>

<h3 style="text-align:center; color:#1e3a8a;">üìä Class Attendance Summary</h3>
<div id="summary"></div>

<!-- History Modal -->
<div id="historyModal" class="modal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeHistory()">X</button>
    <h3 id="historyTitle"></h3>
    <table style="width:100%; border-collapse:collapse;">
      <thead><tr><th>Date</th><th>Batch</th><th>Status</th><th>Reason</th></tr></thead>
      <tbody id="historyBody"></tbody>
    </table>
    <div id="historySummary" style="text-align:center; margin-top:10px; font-weight:600;"></div>
  </div>
</div>

<!-- Call Modal -->
<div id="callModal" class="modal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeCall()">X</button>
    <h3>üìû Parent Contact Info</h3>
    <div id="callInfo" style="text-align:center; font-size:16px; margin-top:10px;"></div>
  </div>
</div>

<script>
  let absentees = [];
  let user;

  function initFaculty() {
    user = requireRole("faculty");
    if (!user) return;
    localStorage.setItem("facultyEmail", user.email);
    document.getElementById("welcome").innerText =
      `üë®‚Äçüè´ ${user.name} (${user.email})`;
  }

  async function loadAbsentees() {
    const date = document.getElementById("date").value;
    const batch = document.getElementById("batch").value;
    const facultyEmail = localStorage.getItem("facultyEmail");
    if (!date || !batch) return alert("Please select both date and batch.");
    if (!facultyEmail) return alert("Faculty email not found. Please log in again.");

    let isLocked = false;
    try {
      const lockCheck = await fetch(SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify({ action: "checkLockStatus", date, batch })
      });
      const lockData = await lockCheck.json();
      if (lockData.locked) {
        isLocked = true;
        alert(`Attendance is locked for this date & batch.\nYou can only view data.`);
      }
    } catch (err) {
      console.error("Lock check failed:", err);
    }

    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify({
        action: "getAbsenteesForFaculty",
        email: facultyEmail,
        date,
        batch
      })
    });

    const data = await res.json();
    if (!data.success) return alert(data.message);
    absentees = data.records || data.data || [];

    renderTable(isLocked);
    renderSummary();
    document.getElementById("facultySectionInfo").innerText =
      `Loaded: ${data.department || user.department} - ${data.year || user.year} ${data.section || user.section}`;

    const saveBtn = document.querySelector(".save");
    saveBtn.disabled = isLocked;
    saveBtn.style.opacity = isLocked ? "0.6" : "1";
  }

  function renderSummary() {
    const summaryDiv = document.getElementById("summary");
    summaryDiv.innerHTML = "";
    if (!absentees.length) {
      summaryDiv.innerHTML = "<p>No records found.</p>";
      return;
    }
    const classMap = {};
    absentees.forEach(s => {
      const key = `${s.Year} ${s.Section}`;
      if (!classMap[key]) classMap[key] = { total: 0, present: 0, absent: 0 };
      classMap[key].total++;
      if (s.Status === "Absent" || s.Status === "OD") classMap[key].absent++;
      else classMap[key].present++;
    });
    for (const key in classMap) {
      const c = classMap[key];
      const percent = ((c.present / c.total) * 100).toFixed(2);
      summaryDiv.innerHTML += `
        <div class="summary-card">
          <h4 style="color:#1e3a8a; margin:0 0 8px;">${key}</h4>
          <p><b>Total:</b> ${c.total}</p>
          <p style="color:green;"><b>Present:</b> ${c.present}</p>
          <p style="color:red;"><b>Absent/OD:</b> ${c.absent}</p>
          <p><b>Attendance:</b> ${percent}%</p>
        </div>`;
    }
  }

  function renderTable(isLocked = false) {
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";
    absentees.forEach((s, i) => {
      tbody.innerHTML += `
        <tr>
          <td>${s.RollNo}</td>
          <td>${s.Name}</td>
          <td>${s.Year}</td>
          <td>${s.Section}</td>
          <td>${isLocked ? `<span>${s.Status}</span>` :
            `<select onchange="absentees[${i}].Status=this.value">
              <option ${s.Status==='Absent'?'selected':''}>Absent</option>
              <option ${s.Status==='OD'?'selected':''}>OD</option>
            </select>`}
          </td>
          <td>${isLocked ? `<span>${s.Reason||'-'}</span>` :
            `<input type="text" value="${s.Reason||''}" onchange="absentees[${i}].Reason=this.value" style="width:120px;">`}
          </td>
          <td>
            <button class="btn" onclick="viewHistory('${s.RollNo}','${s.Name}')">üìú</button>
            <button class="btn" onclick="callParent('${s.ParentPhone||''}', ${i})">üìû</button>
            ${!isLocked ? `<button class="btn" onclick="editParent(${i})">‚úèÔ∏è</button>` : ''}
          </td>
        </tr>`;
    });
  }

  function editParent(index) {
    const s = absentees[index];
    const newPhone = prompt("Edit Parent Phone:", s.ParentPhone || "");
    if (newPhone !== null) absentees[index].ParentPhone = newPhone;
    alert("Parent info updated locally. Click 'Save Changes' to store.");
  }

  async function viewHistory(rollNo, name) {
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify({ action: "getStudentHistory", rollNo })
    });
    const data = await res.json();
    if (!data.success) return alert(data.message);
    const records = data.records;
    const body = document.getElementById("historyBody");
    body.innerHTML = "";
    document.getElementById("historyTitle").innerText = `üìú History of ${name} (${rollNo})`;
    let absentCount = 0, odCount = 0;
    records.forEach(r => {
      if (r.Status === "Absent") absentCount++;
      if (r.Status === "OD") odCount++;
      body.innerHTML += `<tr><td>${r.Date}</td><td>${r.Batch}</td><td>${r.Status}</td><td>${r.Reason||''}</td></tr>`;
    });
    document.getElementById("historySummary").innerHTML = 
      `Total: ${records.length} | Absent: ${absentCount} | OD: ${odCount}`;
    document.getElementById("historyModal").style.display = "flex";
  }

  function closeHistory() { document.getElementById("historyModal").style.display = "none"; }

  function callParent(phoneNumber, index) {
    const s = absentees[index];
    if (!s.ParentPhone && !phoneNumber) return alert("Parent phone number not available!");
    const parentName = s.ParentName || "Not provided";
    const parentPhone = s.ParentPhone || phoneNumber || "Not provided";
    document.getElementById("callInfo").innerHTML = `
      <p><strong>Parent Name:</strong> ${parentName}</p>
      <p><strong>Phone:</strong> ${parentPhone}</p>
      <button onclick="makeCall('${parentPhone}')" class="btn">üìû Call Parent</button>`;
    document.getElementById("callModal").style.display = "flex";
  }
  function makeCall(num) {
    if (!num || num === "Not provided") return alert("Phone number not available!");
    window.open(`tel:${num}`);
  }
  function closeCall() { document.getElementById("callModal").style.display = "none"; }

  async function saveUpdates() {
    const date = document.getElementById("date").value;
    const batch = document.getElementById("batch").value;
    if (!date) return alert("Select a date first!");
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify({ action: "saveFacultyUpdates", date, batch, updates: absentees })
    });
    const result = await res.json();
    alert(result.message);
    if (result.success) await loadAbsentees();

    function openPopup() {
  document.getElementById("popup").style.display = "flex";
}

function closePopup() {
  document.getElementById("popup").style.display = "none";
}

  }
</script>
</body>
</html>



